<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MLeRP User Guide Documentation – applications</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../.././images/favicon-32x32.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../.././images/mstile-150x150.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">MLeRP User Guide Documentation</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../../index.html" aria-current="page">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../faq.html">
 <span class="menu-text">MLeRP FAQ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../dask-slurm.html">
 <span class="menu-text">Quick Start</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://mlerp.cloud.edu.au/launch">
 <span class="menu-text">Log in</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://forms.gle/p9HWS79yxDouP6Tu8">
 <span class="menu-text">Sign up</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">Home</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../about.html" class="sidebar-item-text sidebar-link">About MLeRP</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../faq.html" class="sidebar-item-text sidebar-link">MLeRP FAQ</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../strudelv2_spa/docs/vscode.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../dask-slurm.html" class="sidebar-item-text sidebar-link">Dask SLURMClusters</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../dask-pytorch.html" class="sidebar-item-text sidebar-link">PyTorch and Dask</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#adding-an-appliction" id="toc-adding-an-appliction" class="nav-link active" data-scroll-target="#adding-an-appliction">Adding an appliction</a>
  <ul class="collapse">
  <li><a href="#tldr" id="toc-tldr" class="nav-link" data-scroll-target="#tldr">TLDR;</a></li>
  <li><a href="#the-config-file" id="toc-the-config-file" class="nav-link" data-scroll-target="#the-config-file">The config file</a></li>
  <li><a href="#whats-are-all-these-keys-and-values" id="toc-whats-are-all-these-keys-and-values" class="nav-link" data-scroll-target="#whats-are-all-these-keys-and-values">Whats are all these keys and values</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="adding-an-appliction" class="level1">
<h1>Adding an appliction</h1>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TLDR;</h2>
<p>You need to define a program to run and put the value in <code>startscript</code>. You can’t use #SBATCH pragmas here though. You also need to define a program that will take a jobid and return the port the program is running on and anything else (like access tokens or passwords). This is a paramscmd. The paramscmd can return a json error message. The paramscmd might look easy and a proof of concept might take 5 minutes, but then you get into edge cases and it turns out to be the hardest bit so try to copy an existing one. Next you need the URL to connect to (eg index.html?token=adsf). This is a realtive URL (i.e.&nbsp;if you would normally use ssh tunnels and localhost:<nnn> drop the localhost part Finally you put all this data into a json structure and save it to the config files.</nnn></p>
</section>
<section id="the-config-file" class="level2">
<h2 class="anchored" data-anchor-id="the-config-file">The config file</h2>
<p>Strudel applications look like this</p>
<pre><code> {
   "url": null,
   "name": "Jupyter Lab",
   "startscript": "#!/bin/bash\n/usr/local/sv2/dev/jupyter/jupyter.slurm\n",
   "actions": [ 
       {
           "name": "Connect",
           "paramscmd": "/usr/local/sv2/dev/jupyter/jupyter_params.py {jobid}",
           "client": {"cmd": null, "redir": "?token={token}"},
           "states": ["RUNNING"]
       },
       {
           "name": "View log",
           "paramscmd": "/usr/local/sv2/dev/desktop/logparams.py {jobid}",
           "client": {"cmd": null, "redir": "index.html?token={token}" },
           "states": ["RUNNING","Finished"]
       },
        {
            "name": "View Usage",
            "paramscmd": "/usr/local/sv2/dev/desktop/usageparams.py {jobid}",
            "client": {"cmd": null, "redir": "index.html?token={token}" },
            "states": ["Finished"]
        },
       {
           "name": "Remove log",
           "paramscmd": "/usr/local/sv2/dev/rmlog.py {jobid}",
           "client": null,
           "states": ["Finished"]
       }

   ],
   "localbind": true,
   "applist": null
  },</code></pre>
<p>This is block of json data. It gets stored in a config file. Each compute site has its own list of applications. And if you are running dev and test environments you probably have a different set of applications on each. For M3 the applications are deployed as part of the frontend build (because it was easy to combine the config and the code) but for other sites the URL for this configuration data might be completely independent. For M3 the applications deployed to dev are defined here</p>
<p>https://gitlab.erc.monash.edu.au/hpc-team/strudelv2_spa/blob/dev/src/assets/config/m3apps.dev.json</p>
<p>and the applications for test are here</p>
<p>https://gitlab.erc.monash.edu.au/hpc-team/strudelv2_spa/blob/dev/src/assets/config/m3apps.test.json</p>
<p>In order to deploy a new application you sould edit those files on dev and create a merge request</p>
</section>
<section id="whats-are-all-these-keys-and-values" class="level2">
<h2 class="anchored" data-anchor-id="whats-are-all-these-keys-and-values">Whats are all these keys and values</h2>
<p>The first value <code>url</code> allows up to specify a URL that will provide additional configuration info. We don’t use this for desktops or Jupyter but we might use it for transfering files. The URL should open in an iframe and use window.message methods to pass data back to Strudel2. For most applications this will be set to None.</p>
<p>the <code>name</code> value is reasonably self explinatory but its worth noting: When the form is rendered for what resources to use (CPUs/GPUs/Time) this value is passed to the form so that for example the application named “Desktop” renders a different form than the applictaion named “Jupyter Lab”. Don’t the M3 forms will render a good default for any unknown applicaiton names, so you can pretty much fill in whatever you like.</p>
<p>The <code>startscript</code> gets passed as stdin to whatever command the site runs things with. In the case of M3 this is sbatch, so this contents (start script) gets passed to sbatch. In this example <code>/usr/local/sv2/dev/jupyter/jupyter.slurm</code> i <em>NOT</em> a slurm script. i.e.&nbsp;if you put #SBATCH lines in there they will be ignored. It is a program. If you need to do #SBATCH lines it should be like <code>"startscript": "#!/bin/bash\n#SBATCH -w m3a011\n/usr/local/sv2/dev/jupyter/jupyter.slurm\n",</code> but you really shouldn’t do this. The intention is that the start script doesn’t care what job scheduler your using</p>
<p>Next we have a list of <code>actions</code>. Each of these renders a button in Strudel2 depending on the state of the Job. For each action what happens is tha the the <code>paramscmd</code> gets run and returns a blob of json data. Then the client is executed using the data returned from the <code>paramscmd</code>. The paramscmd should always return a value for <code>port</code> i.e.&nbsp;the network port to connect on and should also return any info used in the <code>client</code> definition (so <code>jupyter_parms.py</code> must return both a port and a token like <code>{"port":123,"token":"abc"}</code>) You sould attempt to copy your params cmd off an existing implementation. Ideally they are not aware of what batch environment is used so that a <code>paramscmd</code> used on a PBS site can be shared with a slurm site. In practice we’ve had to make our paramcmds aware of the jobid and the process tree origining from that job id in order to connect to the correct job (incase multiple jobs are running on the same node)</p>
<p>You’ll notice tha tthe <code>client</code> defines both a <code>cmd</code> and a <code>redir</code>. The <code>cmd</code> field is reserved for future work where Strudle2 can be installed locally and use things like a native vnc viewer instead of a web browser and noVNC.</p>
<p>Next we have the <code>localbind</code> option. This should be set to true. It controls the behaviour of tunnels. In particular you generally can’t access Jupyter from the login node, you have to ssh to the execution host and access using <code>ssh -L 8888:localhost:8888 &lt;exechost&gt;</code> On the other hand if you want to access the SSH server on the execution host you don’t need to do <code>ssh -L 2222:localhost:22 &lt;exechost&gt;</code> you can get stright there from the login node.</p>
<p>Finally the <code>applist</code> option allows for recursivly nexting another list of apps. I implement this feature in the S2 UI, but because its not currently in use and has no test coverage its probably got some bit rot. If you feel the need to have a multilevel list of applications, please contact the developer.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>