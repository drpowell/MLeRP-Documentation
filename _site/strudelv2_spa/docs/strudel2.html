<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MLeRP User Guide Documentation – strudel2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../.././images/favicon-32x32.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../.././images/mstile-150x150.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">MLeRP User Guide Documentation</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../../index.html" aria-current="page">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../faq.html">
 <span class="menu-text">MLeRP FAQ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../dask-slurm.html">
 <span class="menu-text">Quick Start</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://mlerp.cloud.edu.au/launch">
 <span class="menu-text">Log in</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://forms.gle/p9HWS79yxDouP6Tu8">
 <span class="menu-text">Sign up</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">Home</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../about.html" class="sidebar-item-text sidebar-link">About MLeRP</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../faq.html" class="sidebar-item-text sidebar-link">MLeRP FAQ</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../strudelv2_spa/docs/vscode.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../dask-slurm.html" class="sidebar-item-text sidebar-link">Dask SLURMClusters</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../dask-pytorch.html" class="sidebar-item-text sidebar-link">PyTorch and Dask</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overall-flow" id="toc-overall-flow" class="nav-link active" data-scroll-target="#overall-flow">Overall Flow</a></li>
  <li><a href="#components" id="toc-components" class="nav-link" data-scroll-target="#components">Components</a></li>
  <li><a href="#configuration" id="toc-configuration" class="nav-link" data-scroll-target="#configuration">Configuration</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="overall-flow" class="level2">
<h2 class="anchored" data-anchor-id="overall-flow">Overall Flow</h2>
<ol type="1">
<li><p>Frontend static files (html and .js) are fetched. This could be from a CDN but right now its on the same instance as the backend, with a different domain name</p></li>
<li><p>The Frontend generates and ssh key and gets a cert from SSHAuthZ. This is an OAuth2 Implicit flow (original sshauthz by Jason doesn’t support this so I wrote a new one). Access to the cert is mediated by OpenID Connect through either AAF or Google (if Apple gets their act together I’ll be happy to suport login with Apple)</p></li>
<li><p>Having got a certificate the frontend will be able to login to a number of clusters (remember MonARCH CVL@UWA and M3 share the same certificates). Config files will tell the frontend about the login nodes. The frontend (optionally) uses the key/cert to get user info (like quotas) and check cachet.</p></li>
</ol>
<p>At the point the user will select an application (eg a desktop or a jupyter notebook) and the frontend will contact pull in an iframe loaded with the form for the particular login node. This form is reponsible for providing the sbatch command or the pbs command (each cluster therefor has a different form)</p>
<p>Having got the sbatch command the frontend can submit a job to the cluster</p>
<p>At this point all the communication is through the backend component TES (tunnel and execution service). TES understands simple GETs and PUTs as well as ssh tunnels.</p>
<ol start="4" type="1">
<li>Once the job is running, the user can click “Connect” This will open a new tab to to the url “strudel2-api.cloud.cvl.org.au”. This URL path connects to the TWS (Transparent WebSockets Proxy) component. This is cohosted in the same docker container as the TES. Unlike the TES which is written at the HTTP application layer, the TWS is written at the unix socket layer. The TWS will search incomming bytes for a magic cookie then connect these incomming bytes to the correct SSH tunnel.</li>
</ol>
</section>
<section id="components" class="level2">
<h2 class="anchored" data-anchor-id="components">Components</h2>
<p>Each component containts its own documentation directory for installation instructions.</p>
<p>This is the Strudel2 Frontend (an SPA written in angular).</p>
<p>https://gitlab.erc.monash.edu.au/hpc-team/pysshauthz is the SSHAuthZ component needed go map web based login (i.e.&nbsp;OpenID Connect) to SSH certificates for access to the cluster</p>
<p>https://gitlab.erc.monash.edu.au/hpc-team/batchbuilder is the code that provides a form for each application. This version is used by Monash and is specific to slurm.</p>
</section>
<section id="configuration" class="level2">
<h2 class="anchored" data-anchor-id="configuration">Configuration</h2>
<p>There are a number of configuration files for Strudel2. All configs and be subplemented by loading a local json file into the frontend.</p>
<ol type="1">
<li><p>The list of backends. Usually code served from strudel2-test connects to strudel2-api-test but this is not necessarily the case. The list of backends allows the user to choose the closest backend (in terms of network latency) or fail over from one backend to another in the even of an outage.</p></li>
<li><p>The list of SSH AuthZ servers. Each compute site is expected to operate the own sshauthz server, since if you control the CA you can impersonate any user at the site.</p></li>
<li><p>The list of Compute resources (i.e.&nbsp;clusters/sites). Each site</p>
<ul>
<li>a login node</li>
<li>a CA which can issue certs for this login node</li>
<li>website capable fo generating the correct sbatch/qsub/bash command to execute programs</li>
<li>a command to list all jobs</li>
<li>a command to cancel a job</li>
<li>a list of apps</li>
</ul></li>
<li><p>The list of apps. Each application defines:</p>
<ul>
<li>a command to start the application</li>
<li>a number of actions to be preformed on the application (eg connecting to the application). Each action defines
<ul>
<li>A command to return a json blob</li>
<li>A URL that when filled in with data from the json blob will connect the user. Application lists have some extra parameters that are unused. For example applist allows you to define applications recursively (if you want to have desktops served via guacamole or novnc or xrdp). The can also define a URL for configuring the application (As opposed to the URL for configuring the cluster resources). That URL might allow you to configure input files for example. Some possible actions include: Connecting to the App, Viewing the output logs, viewing the sacct reporting for the app.</li>
</ul></li>
</ul></li>
</ol>
<p>Cluster Scripts —————</p>
<p>Depending on what applications a cluster support they will need some simple scripts to start the applications and generate json output (like what port is the application running on and what is its API token/password. For M3 these are installed in /usr/local/sv2 and /usr/local/sv2/dev (for development scripts). I was hoping that these would be independet of the cluster/job scheduler and could be installed into a container along with the application itself, but this is turning out not to be the case. For example, a user might run more than one jupyter notebook on a node, in which case we need a way to determin which notebook they were trying to connect to. The only way to do this turns out to be to use sstat to figure out which processes belong to which job.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>